trigger:
  branches:
    include:
      - main

stages:
# ---------------------------------------------------
# 1. DEV DEPLOYMENT
# ---------------------------------------------------
- stage: Dev
  displayName: "Deploy to Development"
  jobs:
    - job: TerraformDev
      displayName: "Terraform Apply (Dev)"
      pool:
        vmImage: 'ubuntu-latest'

      steps:
        - checkout: self

        - script: |
            echo "Installing Terraform..."
            curl -sLo terraform.zip https://releases.hashicorp.com/terraform/1.8.5/terraform_1.8.5_linux_amd64.zip
            unzip terraform.zip
            sudo mv terraform /usr/local/bin/
            terraform version
          displayName: "Install Terraform"

        - task: AzureCLI@2
          displayName: "Terraform Init (Dev)"
          inputs:
            azureSubscription: "stevens-service-conn"
            scriptType: bash
            scriptLocation: inlineScript
            workingDirectory: environments/dev
            inlineScript: |
              TENANT_ID=$(az account show --query tenantId -o tsv)
              SUBSCRIPTION_ID=$(az account show --query id -o tsv)
              ACCOUNT_NAME=$(az account show --query name -o tsv)
              ACCOUNT_USER_TYPE=$(az account show --query user.type -o tsv)
              terraform init

        - task: AzureCLI@2
          displayName: "Terraform Plan (Dev)"
          inputs:
            azureSubscription: "stevens-service-conn"
            scriptType: bash
            scriptLocation: inlineScript
            workingDirectory: environments/dev
            inlineScript: |
              TENANT_ID=$(az account show --query tenantId -o tsv)
              SUBSCRIPTION_ID=$(az account show --query id -o tsv)
              ACCOUNT_NAME=$(az account show --query name -o tsv)
              ACCOUNT_USER_TYPE=$(az account show --query user.type -o tsv)
              terraform plan -var-file="terraform.tfvars" -out=tfplan

        - task: AzureCLI@2
          displayName: "Terraform Apply (Dev)"
          inputs:
            azureSubscription: "stevens-service-conn"
            scriptType: bash
            scriptLocation: inlineScript
            workingDirectory: environments/dev
            inlineScript: |
              TENANT_ID=$(az account show --query tenantId -o tsv)
              SUBSCRIPTION_ID=$(az account show --query id -o tsv)
              ACCOUNT_NAME=$(az account show --query name -o tsv)
              ACCOUNT_USER_TYPE=$(az account show --query user.type -o tsv)
              terraform apply -auto-approve tfplan

# ---------------------------------------------------
# 2. PROD DEPLOYMENT (Manual Approval Before Running)
# ---------------------------------------------------
- stage: Prod
  displayName: "Deploy to Production"
  dependsOn: Dev
  condition: succeeded()

  jobs:
    - deployment: TerraformProd          # <-- deployment job required
      displayName: "Terraform Apply (Prod)"
      environment: "production-env"      # <-- now valid!
      
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              - script: |
                  echo "Installing Terraform..."
                  curl -sLo terraform.zip https://releases.hashicorp.com/terraform/1.8.5/terraform_1.8.5_linux_amd64.zip
                  unzip terraform.zip
                  sudo mv terraform /usr/local/bin/
                  terraform version
                displayName: "Install Terraform"

              - task: AzureCLI@2
                displayName: "Terraform Init (Prod)"
                inputs:
                  azureSubscription: "stevens-service-conn"
                  scriptType: bash
                  scriptLocation: inlineScript
                  workingDirectory: environments/prod
                  inlineScript: |
                    TENANT_ID=$(az account show --query tenantId -o tsv)
                    SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                    ACCOUNT_NAME=$(az account show --query name -o tsv)
                    ACCOUNT_USER_TYPE=$(az account show --query user.type -o tsv)
                    terraform init

              - task: AzureCLI@2
                displayName: "Terraform Plan (Prod)"
                inputs:
                  azureSubscription: "stevens-service-conn"
                  scriptType: bash
                  scriptLocation: inlineScript
                  workingDirectory: environments/prod
                  inlineScript: |
                    TENANT_ID=$(az account show --query tenantId -o tsv)
                    SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                    ACCOUNT_NAME=$(az account show --query name -o tsv)
                    ACCOUNT_USER_TYPE=$(az account show --query user.type -o tsv)
                    terraform plan -var-file="terraform.tfvars" -out=tfplan

              - task: AzureCLI@2
                displayName: "Terraform Apply (Prod)"
                inputs:
                  azureSubscription: "stevens-service-conn"
                  scriptType: bash
                  scriptLocation: inlineScript
                  workingDirectory: environments/prod
                  inlineScript: |
                    TENANT_ID=$(az account show --query tenantId -o tsv)
                    SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                    ACCOUNT_NAME=$(az account show --query name -o tsv)
                    ACCOUNT_USER_TYPE=$(az account show --query user.type -o tsv)
                    terraform apply -auto-approve tfplan
